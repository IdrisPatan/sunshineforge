buildscript {
    ext {
        springBootVersion = '1.4.2.RELEASE'
    }
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")
    }
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'idea'
apply plugin: 'org.springframework.boot'
apply plugin: "jacoco"

jar {
    baseName = '01-endpoints'
    version = '0.0.1-SNAPSHOT'
}
sourceCompatibility = 1.8
targetCompatibility = 1.8

repositories {
    mavenCentral()
}

sourceSets {
    integration {
        java.srcDir file('integration/java')
        resources.srcDir file('integration/resources')
    }
}

task integration(type: Test) {
    testClassesDir = sourceSets.integration.output.classesDir
    classpath = sourceSets.integration.runtimeClasspath
}

ext {
    limits = [
            'instruction': 75,
            'branch'     : 75,
            'line'       : 75,
            'complexity' : 80,
            'method'     : 80,
            'class'      : 97.5
    ]
}

jacocoTestReport {
    reports {
        xml.enabled true
    }

    // taken from https://github.com/springfox/springfox/blob/master/gradle/coverage.gradle
    // TODO: When [this PR](https://github.com/gradle/gradle/issues/824) gets released
    // we can get automated coverage from the jacoco plugin
    doLast {
        def report = file("${jacoco.reportsDir}/test/jacocoTestReport.xml")
        def htmlReport = file("${jacoco.reportsDir}/test/html/index.html")
        logger.lifecycle("Checking coverage results: ${report}")
        logger.lifecycle("Html report: ${htmlReport}")

        def parser = new XmlParser()
        parser.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd", false);
        parser.setFeature("http://apache.org/xml/features/disallow-doctype-decl", false)
        def results = parser.parse(report)

        def percentage = {
            if (null == it) {
                //if it does not exist assume 100%
                return 100
            }
            def covered = it.'@covered' as Double
            def missed = it.'@missed' as Double
            ((covered / (covered + missed)) * 100).round(2)
        }

        def counters = results.counter
        def metrics = [:]
        metrics << [
                'instruction': percentage(counters.find { it.'@type'.equals('INSTRUCTION') }),
                'branch'     : percentage(counters.find { it.'@type'.equals('BRANCH') }),
                'line'       : percentage(counters.find { it.'@type'.equals('LINE') }),
                'complexity' : percentage(counters.find { it.'@type'.equals('COMPLEXITY') }),
                'method'     : percentage(counters.find { it.'@type'.equals('METHOD') }),
                'class'      : percentage(counters.find { it.'@type'.equals('CLASS') })
        ]


        def failures = []
        def canIncrease = []
        metrics.each {
            def limit = limits[it.key]
            if (it.value < limit) {
                failures.add("- ${it.key} coverage rate is: ${it.value}%, minimum is ${limit}%")
            }
            if (it.value > limit + 1) {
                canIncrease.add("- ${it.key} coverage rate is: ${it.value}%, minimum is ${limit}%")
            }
        }

        if (failures) {
            logger.quiet("------------------ Code Coverage Failed -----------------------")
            failures.each {
                logger.quiet(it)
            }
            logger.quiet("---------------------------------------------------------------")
            if (!project.hasProperty("skipCoverage")) {
                throw new GradleException("Code coverage failed")
            }
        }
        if (canIncrease) {
            logger.quiet("------------------ Code Coverage Improved! -----------------------")
            canIncrease.each {
                logger.quiet(it)
            }
            logger.quiet("---------------------------------------------------------------")
        }
    }

}


dependencies {
    compile('org.springframework.boot:spring-boot-starter-web')
    testCompile('org.springframework.boot:spring-boot-starter-test')
    testCompile('com.jayway.jsonpath:json-path-assert:2.2.0')

    integrationCompile sourceSets.main.output
    integrationCompile configurations.testCompile
    integrationCompile sourceSets.test.output
    integrationRuntime configurations.testRuntime
}
